import wrapPost from '../../layouts/wrapPost.js';

export const options = {
  title: 'åœ¨ Web ä¸Šå»ºæ§‹åŠåˆ†æ•£å¼ç¶²è·¯ã€èŠå¤©å®¤ - ä½¿ç”¨ WebRTC & WebSocket',
  thumbnail: 'https://i.imgur.com/VjtceVUh.jpg',
  createdAt: '2021/01/15',
};

export default wrapPost;

> æœ¬ç¯‡ç”± 2019/9/7 æ’°å¯«ä¹‹ [https://5xruby.tw/posts/webrtc-unnamed-netowrk-chatroom/](https://5xruby.tw/posts/webrtc-unnamed-netowrk-chatroom/) ä¿®æ”¹è€Œä¾†

ç­†è€…åœ¨ [COSCUP 2019 è¬›äº† WebRTC å»ºç«‹åŠåˆ†æ•£å¼ç¶²è·¯çš„ä¸€äº›å¿ƒè·¯æ­·ç¨‹](https://coscup.org/2019/programs/58fcc6a0-1e5c-4a17-af0a-3e3dfba381c4)ï¼ŒçµæŸä¹‹å¾Œä½¿ç”¨æ­¤åŠåˆ†æ•£å¼é€£ç·šæ¡†æ¶è£½ä½œäº†ä¸€å€‹ç•Œé¢çœ‹èµ·ä¾†æ¯”è¼ƒå¯ä»¥çš„èŠå¤©å®¤ï¼Œè€Œä¸”æä¾› Youtube å½±ç‰‡åŒæ­¥æ’­æ”¾åŠŸèƒ½ï¼š

### [https://static.pastleo.me/unnamed-network-chat-ysync/](https://static.pastleo.me/unnamed-network-chat-ysync/)

> é€™é‚Šçš„å¸¸é§ websocket peer æ¶è¨­åœ¨å…è²»çš„ heroku ä¸Šï¼Œç¶²é æ‰“é–‹è«‹ç­‰å¾… `there are 1 neighbors... wss://un-wss-node-1.herokuapp.com` å‡ºç¾å†é€²è¡Œæ“ä½œï¼Œå¦‚æœè¨±ä¹…æ²’æœ‰å‡ºç¾å¯ä»¥é‡æ•´ä¸€æ¬¡è©¦è©¦

å¦‚ä½•å»ºç«‹/åŠ å…¥ç¾¤çµ„ï¼š

<iframe width="560" height="315" src="https://www.youtube.com/embed/ywDQOYW79dU" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>

èŠå¤©å®¤ä½¿ç”¨ä»¥åŠ YOUTUBE åŒæ­¥æ’­æ”¾æ•™å­¸ï¼š

<iframe width="560" height="315" src="https://www.youtube.com/embed/kogpQkkBlGY" frameBorder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>

æ¥ä¸‹ä¾†æ˜¯é€™å€‹èŠå¤©å®¤çš„é€£ç·šæ¡†æ¶ï¼ˆä¸‹é¢ç¨±ç‚º `unnamed-network`ï¼‰çš„å¿ƒè·¯æ­·ç¨‹ï¼Œä¹Ÿæ˜¯ [COSCUP 2019 WebRTC åŠåˆ†æ•£ç¶²è·¯çš„æŠ•å½±ç‰‡](https://md.pastleo.me/p/webrtc-network-coscup2019-talk#/) æ•´ç†å‡ºä¾†çš„çµæœ

## WebRTC æ˜¯ä»€éº¼ï¼Ÿ

å¦‚æœä¸çŸ¥é“ä»€éº¼æ˜¯ WebRTCï¼Œå¯ä»¥åƒè€ƒå»å¹´å¯«çš„æ–‡ç« ï¼š[https://5xruby.tw/posts/webrtc/](https://5xruby.tw/posts/webrtc/)

ç°¡å–®ä¾†èªª WebRTC å¯ä»¥è®“ç€è¦½å™¨ç›´æ¥è·Ÿç€è¦½å™¨é€£ç·šï¼Œä½†æ˜¯é€£ç·šçš„å»ºç«‹å¾ˆéº»ç…©ï¼Œé–‹ç™¼è€…è¦è‡ªå·±æƒ³è¾¦æ³•è®“å…©å€‹ç€è¦½å™¨äº¤æ› handshake è³‡è¨Š (offer, answer, ice)

> ä¸Šé¢çš„ DEMO åªæœ‰ [STUN](https://en.wikipedia.org/wiki/STUN)ï¼Œå°±å¦‚åŒ [é€™é‚Š](https://pastleo.me/post/20201130-webrtc#STUN%20&%20TURN) æ‰€èªªï¼Œé€£ç·šçš„å…©è€…æœƒå—åˆ°é›™æ–¹ç¶²è·¯æ¶æ§‹å½±éŸ¿ï¼Œä¾‹å¦‚ symetric NAT çš„ç‹€æ³å°±æœƒå°è‡´ [STUN](https://en.wikipedia.org/wiki/STUN) ç„¡æ³•æ‰“é€šè€Œç„¡æ³•é€£ç·š

## Multiplayer game using WebRTC

è·Ÿæœ‹å‹ä¸€èµ·åšçš„éŠæˆ²å°ˆæ¡ˆ -- Bazaarï¼Œå°±å¦‚åŒä¸‹é¢é€™å€‹å½±ç‰‡é€™æ¨£ï¼Œå¯ä»¥æœ‰å¤šå€‹ç©å®¶åœ¨ç•«é¢ä¸Šèµ°ä¾†èµ°å»è·³ä¾†è·³å»ï¼Œç§»å‹•ç­‰è³‡è¨Šå°±æ˜¯é€é WebRTC å‚³è¼¸çš„

![](https://static.pastleo.me/assets/bazaar-coscup-demo.gif)

* ç¨‹å¼ç¢¼ï¼š [https://github.com/pastleo/bazaar](https://github.com/pastleo/bazaar)
* æƒ³è©¦ç©ï¼Ÿåœ¨é€™ï¼š [https://bazaar-pre.pastleo.me/](https://bazaar-pre.pastleo.me/)

### Bazaar client ä¹‹é–“çš„é€£ç·šæ–¹æ³•

ç›´æ¥åšå…¨é€£ç·šï¼Œé¦–å…ˆç”¨ websocket è·Ÿä¼ºæœå™¨ (wss) é€£ç·šï¼Œæ¥è‘—èˆ‡æ‰€æœ‰ç©å®¶é€£ç·š

![](https://i.imgur.com/3auxTBw.gif)

1. firefox èˆ‡ wss é€£ç·š
2. firefox èˆ‡ wss é€£ç·šå®Œæˆ
3. chromium èˆ‡ wss é€£ç·š
4. chromium èˆ‡ wss é€£ç·šå®Œæˆ
5. chromium é€é wss èˆ‡ firefox å»ºç«‹ WebRTC é€£ç·š
6. chromium èˆ‡ firefox çš„ WebRTC é€£ç·šå»ºç«‹å®Œæˆ
7. safari èˆ‡ wss é€£ç·š
8. safari èˆ‡ wss é€£ç·šå®Œæˆ
9. safari é€é wss èˆ‡ firefox ä»¥åŠ chromium å»ºç«‹ WebRTC é€£ç·š
10. safari èˆ‡ firefox ä»¥åŠ chromium çš„ WebRTC é€£ç·šå»ºç«‹å®Œæˆ

é€™é‚Šå¾ˆå¿«å°±æœƒç™¼ç¾ä¸€ä»¶äº‹ï¼Œå°±æ˜¯æ¯å€‹ç©å®¶çš„é€£ç·šæ•¸æ˜¯ç¸½ç©å®¶æ•¸ - 1ï¼Œä¹Ÿå°±æ˜¯èªªå‡è¨­æœ‰ 20 å€‹äººåœ¨å ´ä¸Šï¼Œç€è¦½å™¨è¦å»ºç«‹ 19 å€‹é€£ç·š...é›–ç„¶æ²’æœ‰æ˜å®š WebRTC çš„é€£ç·šæ•¸é™åˆ¶...ä½†æ˜¯æˆ‘è‡ªå·±å¾Œä¾†åšæ¸¬è©¦æ™‚å¤§æ¦‚ 30 ~ 40 å€‹é€£ç·šæ™‚ chromium æœƒè·Ÿæˆ‘èªªå¤ªå¤šé€£ç·šä¸å…è¨±å»ºç«‹æ›´å¤šé€£ç·š

## ä¸€å€‹ç™¼æƒ³ï¼šå¦‚æœ server å¯ä»¥æ˜¯ä¸€å€‹ NPC...

ä¸€å€‹åˆ†æ•£å¼çš„æƒ³æ³•ï¼ŒæŠŠ websocket server ç•¶æˆ client çœ‹å¾…ï¼Œç‚ºäº†è®“ browser å°å¾… server å°±è·Ÿå…¶ä»– browser ä¸€æ¨£ï¼Œå˜—è©¦è£½ä½œ WebRTC è·Ÿ WebSocket å…±ç”¨çš„ç•Œé¢

### WebRTC èˆ‡ WebSocket å…±ç”¨çš„ interface

![](https://static.pastleo.me/assets/190815150840.svg)

å°æ–¼ wsConn ä»¥åŠ rtcConn ä¾†èªªï¼Œæä¾›çš„åŠŸèƒ½å°±æ˜¯é€è¨Šæ¯ä»¥åŠæ¥æ”¶è¨Šæ¯ï¼Œå¾ˆå®¹æ˜“åšæˆå…±ç”¨çš„ç•Œé¢

é›–ç„¶å…©è€…å»ºç«‹é€£ç·šçš„æ–¹å¼æœ‰å¾ˆå¤§çš„ä¸åŒï¼Œä½†æ˜¯ WebRTC é€£ç·šå»ºç«‹å…¶å¯¦å°±æ˜¯éœ€è¦ä¸€å€‹ç¯€é»å¹«å¿™å‚³é€ handshaking è³‡æ–™ï¼Œæ–¼æ˜¯è©¦è‘—è“‹ä¸€å±¤ peerConnsï¼Œä¸Šé¢æä¾› API `connect(peer, viaPeer)`

![](https://static.pastleo.me/assets/190815153930.svg)

* `peer` å¦‚æœæ˜¯ WebSocket URLï¼Œå‰‡ä¸éœ€è¦ `viaPeer`ï¼Œç›´æ¥é€£ç·šå°±å¥½ï¼Œè€Œä¸”å°±ç®—çµ¦ `viaPeer` ä¹Ÿä¸æœƒæ€éº¼æ¨£
* `peer` å¦‚æœæ˜¯ä¸€å€‹ç€è¦½å™¨ (æ¯å€‹ç€è¦½å™¨åˆå§‹åŒ–æ™‚æœƒè‡ªå‹•ç”¢ç”Ÿä¸€å€‹ id)ï¼Œå¿…é ˆçµ¦ä¸Š `viaPeer` æŒ‡å®šä¸€å€‹ç¯€é»å¹«å¿™å‚³é€ handshaking è³‡æ–™å»ºç«‹é€£ç·š

> ä¸é bazaar éŠæˆ²åˆ°ç›®å‰ç‚ºæ­¢ `viaPeer` æ°¸é æœƒæ˜¯ wss

## é€é browser é€²è¡Œ WebRTC é€£ç·šå»ºç«‹æœƒæ˜¯ä»€éº¼æ¨£å­ï¼Ÿ

WebRTC é€£ç·šä¸€å®šæœƒéœ€è¦ä¸€å€‹ç¯€é»å¹«å¿™åšé€£ç·šï¼Œå› æ­¤

* ç¬¬ä¸€å€‹é€£ç·šä¸€å®šæ˜¯ WebSocket

å¾Œä¾†å¯ä»¥é€éç€è¦½å™¨å¹«å¿™é€£ç·šï¼Œå› æ­¤

* åŠ å…¥ç¶²è·¯ä¹‹å¾Œå¯ä»¥é—œé–‰ WebSocket é€£ç·š

èˆ‰å€‹ä¾‹å­ä¾†è·‘ä¸€æ¬¡çœ‹çœ‹ï¼š

![](https://i.imgur.com/jTHtCHY.gif)

1. å‡è¨­ä¸€é–‹å§‹ chromium å·²ç¶“è·Ÿ firefox å»ºç«‹ WebRTC é€£ç·šï¼Œchromium å·²ç¶“è·Ÿ wss å»ºç«‹ WebSocket é€£ç·šï¼Œè€Œä¸” firefox æ²’æœ‰è·Ÿ wss é€£ç·š
2. safari èˆ‡ wss é€£ç·š
3. safari èˆ‡ wss é€£ç·šå®Œæˆ
4. safari é€é wss èˆ‡ chromium å»ºç«‹ WebRTC é€£ç·š
5. safari èˆ‡ chromium çš„ WebRTC é€£ç·šå»ºç«‹å®Œæˆ
6. safari é€é chromium èˆ‡ firefox å»ºç«‹ WebRTC é€£ç·š
7. safari èˆ‡ firefox çš„ WebRTC é€£ç·šå»ºç«‹å®Œæˆ

é›–ç„¶ç¬¬ä¸€å€‹é€£ç·šä¸€å®šæ˜¯ WebSocketï¼Œä¸éé‚„æ˜¯å¯ä»¥æŸç¨®ç¨‹åº¦çš„é™ä½å° WebSocket server çš„ä¾è³´æ€§ï¼Œæ–¼æ˜¯å°±é–‹å§‹å˜—è©¦æŠŠæ•´å€‹é€£ç·šçš„æ±è¥¿æŠ½å‡ºä¾†åš...

## åŠåˆ†æ•£å¼ç¶²è·¯

ç¸½çµå‰é¢çš„æƒ³æ³•ï¼Œé€™å€‹æ±è¥¿æš«æ™‚å«ä»– `unnamed-network`ï¼ŒæŠ½æˆä¸€å€‹å°ˆæ¡ˆä¸¦ä¸”ï¼š

* æ”¹ç”¨ nodejs å¯¦åš wss ç«¯
  * åŸæœ¬ WebSocket server éƒ½æ˜¯ Elixir åšçš„ï¼Œæ—¢ç„¶ wss ç«¯è¢«ç•¶æˆ clientï¼Œé€™æ¨£å¯ä»¥é¿å…åŒæ¨£åŠŸèƒ½è¦å¯¦åšå…©å€‹ç‰ˆæœ¬
* å…è¨±é€™å€‹ç¶²è·¯å­˜åœ¨è¤‡æ•¸å€‹ wssï¼Œè€Œä¸”ç†æƒ³ä¸Šæ‡‰è©²æœ‰è¤‡æ•¸å€‹
* åŠ å…¥ç¾¤çµ„åŠŸèƒ½
  * ä¸€å€‹ client å¯ä»¥åŒæ™‚åŠ å…¥å¤šå€‹ group
  * å¯ä»¥é€²è¡Œç¾¤çµ„å»£æ’­

### `unnamed-network` å°ˆæ¡ˆï¼š

#### [https://github.com/pastleo/unnamed-network](https://github.com/pastleo/unnamed-network)

### `unnamed-network` çš„æ¶æ§‹

![](https://static.pastleo.me/assets/190815183330.svg)

* [wsConn](https://github.com/pastleo/unnamed-network/blob/85b261d2f4ba77b87e533b7b2d3e0c5404e0afe3/lib/conn/ws.js) èˆ‡ [rtcConn](https://github.com/pastleo/unnamed-network/blob/85b261d2f4ba77b87e533b7b2d3e0c5404e0afe3/lib/conn/rtc.js) éƒ¨ä»½å¹¾ä¹èˆ‡ä¸Šé¢ä¸€æ¨£è² è²¬æ”¶ç™¼è¨Šæ¯
* [connProvider](https://github.com/pastleo/unnamed-network/blob/85b261d2f4ba77b87e533b7b2d3e0c5404e0afe3/lib/connProvider/base.js) éƒ¨ä»½è² è²¬è™•ç† [browser](https://github.com/pastleo/unnamed-network/blob/85b261d2f4ba77b87e533b7b2d3e0c5404e0afe3/lib/connProvider/browser.js) èˆ‡ [wss](https://github.com/pastleo/unnamed-network/blob/85b261d2f4ba77b87e533b7b2d3e0c5404e0afe3/lib/connProvider/wss.js) æ¥å—é€£ç·šæ™‚è¡Œç‚ºä¸Šçš„ä¸åŒ
* [connManager](https://github.com/pastleo/unnamed-network/blob/85b261d2f4ba77b87e533b7b2d3e0c5404e0afe3/lib/connManager.js) èˆ‡ä¸Šé¢å·®ä¸å¤šï¼Œæä¾› `connect(peer, viaPeer)` çµ¦ä¸Šå±¤ä½¿ç”¨
* [client](https://github.com/pastleo/unnamed-network/blob/85b261d2f4ba77b87e533b7b2d3e0c5404e0afe3/lib/client.js) éƒ¨ä»½è² è²¬ç¶²è·¯çš„ç¶­æŒä¸¦æä¾›ç¾¤çµ„åŠŸèƒ½

### connManager é€£ç·šå»ºç«‹ç­–ç•¥

å› ç‚º wss ä¹Ÿåªæ˜¯ä¸€å€‹ client äº†ï¼Œwss ä¹Ÿå¾ˆæœ‰å¯èƒ½æœƒæƒ³è¦ä¸»å‹•èˆ‡ä»–äººé€£ç·šï¼Œåˆ—èˆ‰ä¸€ä¸‹æ•´ç†æˆå››ç¨®æƒ…æ³ï¼š

| å·¦ä¸‹é€£å³ä¸Š | wss    | browser       |
|----------|--------|---------------|
| wss      | ws ç›´é€£ | é‚€è«‹é€£ ws `ğŸ¤` |
| browser  | ws ç›´é€£ | WebRTC `ğŸ¤`   |

é€™é‚Šæ¯”è¼ƒæœ‰è¶£çš„å°±æ˜¯ã€ç•¶ wss æƒ³è¦é€£åˆ° browserã€çš„ç‹€æ³ï¼Œé€™é‚Šæƒ³åˆ°çš„æ–¹æ³•æ˜¯é€é viaPeer é‚€è«‹ browser ä¾†é€£ wssï¼›éœ€è¦ viaPeer çš„éƒ¨ä»½æ¨™ä¸Š `ğŸ¤`ï¼Œæ‰€ä»¥çµè«–ä¾†èªªä¸æ˜¯åªæœ‰ WebRTC æœƒéœ€è¦ viaPeer

### ç¶²è·¯çš„ç¶­æŒä»¥åŠç¾¤çµ„åŠŸèƒ½

é€™å°±æ˜¯é‚„å¾ˆä¸å®Œå–„çš„éƒ¨ä»½äº†ï¼Œé€™é‚Šå°±ç¨å¾®è¬›ä¸€ä¸‹ç›®å‰é‹ä½œçš„è¡Œç‚º

* åˆå§‹åŒ–æ™‚
  * æ¯å€‹ client æœ‰ä¸€å€‹ known list ç´€éŒ„å·²çŸ¥çš„ wss
  * æ‰€æœ‰ client éƒ½æœƒåŠ å…¥ `"/"` ç¾¤çµ„
* åŠ å…¥ç¾¤çµ„æ™‚
  * å° `"/"` è«‹æ±‚ `route-group`
    * max hops: 10
  * åŠ å…¥ç¾¤çµ„æ™‚ç™¼ç¾æ‰¾ä¸åˆ°äººå°±æ˜¯å»ºç«‹æ–°ç¾¤çµ„

æ²’é—œä¿‚é€™é‚Šæœ‰ç°¡æ˜“çš„æ¡ˆä¾‹ï¼š

![](https://i.imgur.com/gpqosXj.gif)

1. å‡è¨­ä¸€é–‹å§‹æœ‰ä¸€å€‹ `group1` æœ‰ä¸‰å€‹äººï¼Œå…¶ä¸­ chrome èˆ‡ wss é€£ç·š
2. safari å› ç‚º known list çŸ¥é“ wss çš„å­˜åœ¨ï¼ŒåŠ å…¥ `"/"` ç¾¤çµ„æ™‚æœƒå»æ‰¾ wss é€£ç·š
3. safari èˆ‡ wss é€£ç·šå»ºç«‹
4. safari å°è‘— `"/"` ç¾¤çµ„çš„ç¯€é»è©¢å• `route-group` `group1` æ€éº¼èµ°ï¼Œå› æ­¤å°è‘— wss ç™¼å•
5. wss å°è‘— `"/"` ç¾¤çµ„çš„ç¯€é»è©¢å• `route-group` `group1` æ€éº¼èµ°ï¼Œå› ç‚ºè©¢å•ä¾†è‡ª safariï¼Œå› æ­¤å°è‘— chrome ç™¼å•
6. chrome è‡ªå·±åœ¨ `group1`ï¼Œå›è¦†è‡ªå·±çš„ id
7. wss æ”¶åˆ°å›è¦†ï¼Œå›è¦† safari å¾—åˆ°çš„ id åŠ ä¸Šè‡ªå·±çš„ id
8. safari é€é wss èˆ‡ chrome é€£ç·šé€²å…¥ `group1`ï¼Œå› æ­¤é€é wss èˆ‡ chrome é€²è¡Œ WebRTC é€£ç·šä¸¦è«‹æ±‚åŠ å…¥ `group1`
9. safari èˆ‡ chrome çš„ WebRTC é€£ç·šå»ºç«‹å®Œæˆä¸¦ä¸”åŠ å…¥ `group1`

ä¸éé€™å€‹ç¶²è·¯é¡¯ç„¶å¤§å®¶æœƒä¾†ä¾†å»å»çš„ï¼Œsafari åªè·Ÿ group1 ä¿æŒä¸€å€‹é€£ç·šæ„Ÿè¦ºå¾ˆå±éšªï¼Œæ‰€ä»¥åŠ ä¸Š neighbor æ•¸é‡ç¶­è­·çš„æ©Ÿåˆ¶ï¼Œæ¯å€‹ç¯€é»è‡ªå·±æœƒç›¡å¯èƒ½ç¶­æŒä¸€å€‹ç¾¤çµ„å…§çš„é€£ç·šæ•¸ï¼ˆä¹Ÿå°±æ˜¯é„°å±… neighbor æ•¸ï¼‰åœ¨ 3 - 6 å€‹ä¹‹é–“ï¼š

* ä½æ°´ä½: `3`ï¼Œä½æ–¼é€™å€‹æ•¸é‡æœƒå˜—è©¦å°‹æ‰¾æ›´å¤š neighbor
* é«˜æ°´ä½: `6`ï¼Œé«˜æ–¼é€™å€‹æ•¸é‡æœƒå»æ¸›å°‘ neighbor æ•¸é‡
* æ»¿æ°´ä½: `10`ï¼Œä¸æ¥å—æ›´å¤šé€£ç·š
  * wss çš„æ»¿æ°´ä½è¨­å®šåœ¨ `100` é¿å…åŠ å…¥ä¸äº†ç¶²è·¯

æ‰€ä»¥èˆ‰ä¾‹ä¾†èªªï¼š

![](https://i.imgur.com/nvyvc9q.gif)

1. å‡è¨­å»¶çºŒå‰›å‰›å»ºç«‹çš„ç‹€æ…‹ï¼Œä¸” wss å·²ç¶“èˆ‡å¦å¤– 5 å€‹ç¯€é»é€£ç·š
2. wss æœ‰ 7 å€‹é€£ç·šäº†ï¼Œéœ€è¦éš¨æ©ŸæŒ‘é¸ä¸€å€‹ç¯€é»æ–·ç·šï¼Œé€™é‚Šå‡è¨­é¸æ“‡ safari æ–·ç·šï¼ŒåŒæ™‚ safari ç™¼è¦ºè‡ªå·±çš„ neighbor éå°‘ï¼Œè©¢å• `group1` æ˜¯å¦é‚„æœ‰å…¶ä»–äºº
3. chrome å›è¦†å…¶ä»– neighbor çš„ id (firefox1, firefox2)
4. safari é€é chrome èˆ‡ firefox1, firefox2 å»ºç«‹ WebRTC é€£ç·š
5. safari èˆ‡ firefox1, firefox2 çš„ WebRTC é€£ç·šå»ºç«‹å®Œæˆ

èŠ±äº†é€™éº¼å¤šåŠ›æ°£å»ºç«‹äº†ç¶²è·¯...ç¸½å¾—ä¾†é€äº›è¨Šæ¯å§ï¼Ÿç¾¤çµ„å»£æ’­çš„æ™‚å€™ç™¼èµ·å»£æ’­çš„ç¯€é»éœ€è¦é™„ä¸Šéš¨æ©Ÿçš„ `msgId` ç„¶å¾Œé€çµ¦ neighborsï¼Œæ”¶åˆ°å»£æ’­è¨Šæ¯çš„ç¯€é»å…ˆçœ‹ä¸€ä¸‹ `msgId` æ˜¯å¦æœ‰çœ‹éï¼Œå¦‚æœçœ‹éå°±ä¸è¦ç†ä»–ï¼Œåä¹‹å‰‡è§¸ç™¼äº‹ä»¶å‘Šè¨´æ›´ä¸Šé¢çš„ application å±¤ä¸¦ä¸”ç¹¼çºŒå‚³éè‡ªå·±çš„å…¶ä»– neighborsï¼Œä¸€æ¨£èˆ‰å€‹ä¾‹å­ï¼š

![](https://i.imgur.com/ZRESfTl.gif)

1. å‡è¨­ group1 å·²ç¶“æœ‰ 6 å€‹ç¯€é»ï¼Œé€£æ¥çš„æ‹“æ’²ä¸Šæœ‰ç’°
2. safari ç™¼å‡ºå»£æ’­ï¼Œå‡è¨­ `msgId` ç‚º `123`ï¼Œå‚³é€çµ¦ chrome, firefox èˆ‡å¦ä¸€å€‹ safari
3. chrome èˆ‡ firefox ä¹‹é–“å¦‚æœåˆæ”¶åˆ°åŒæ¨£çš„ `msgId` `123`ï¼Œå‰‡æœƒé¿å…ç¹¼çºŒå†æŠŠè¨Šæ¯æ•£å¸ƒä¸‹å»

ä¸éå¦‚æœæœ‰ neighbor é›¢é–‹, æ–·ç·šåˆæˆ–æ˜¯ä¸€å †äººé›¢é–‹çš„æ™‚å€™ï¼Œé‚„æ²’æœ‰æƒ³åˆ°ä¸€å€‹å¥½æ–¹æ³•é¿å…å­¤å³¶ç”¢ç”Ÿï¼Œç›®å‰çš„æ–¹å¼å°±æ˜¯é‡æ–°æ‰¾ wss åŠ å…¥ç¾¤çµ„ï¼Œå…¶å¯¦æ˜¯å¾ˆæ²’æ•ˆç‡è€Œä¸”å¾ˆå®¹æ˜“å‡ºå•é¡Œçš„æ–¹æ³•...æ‰€ä»¥é€™å€‹ç¶²è·¯æˆ–è¨±å»ºç«‹é€£ç·šçš„æ™‚å€™é‚„è¡Œï¼Œä½†å¦‚æœè¦åœ¨äººä¾†ä¾†å»å»çš„æƒ…æ³ä¸‹æŒçºŒé‹ä½œæ˜¯è‚¯å®šæœ‰å•é¡Œçš„

### è¦è®“ `unnamed-network` èƒ½ç”¨çš„è©±éœ€è¦...

* èƒ½è·¨å¤šå€‹ node é€²è¡Œé€£ç·šä»¥å¢åŠ å¤š hop é€£ç·šæ•ˆç‡
  * ä¸Šé¢æåˆ°é€é viaPeerï¼Œæ„æ€æ˜¯åªèƒ½é€éä¸€å€‹ç¯€é»ä¾†å¹«å¿™é€£ç·šï¼Œå¦‚æœè¦è·¨å¤šå€‹é»é€£ç·šå‰‡æ˜¯è¦ä¾åºè·Ÿè·¯ä¸Šæ‰€æœ‰äººå»ºç«‹é€£ç·š
* wss èƒ½å¤ æä¾› stun/turn æœå‹™ï¼Œæœ‰è‡ªå·±å˜—è©¦æ¶è¨­äº† stun server ç”¨åœ¨ä¸Šé¢çš„ demo çœ‹èµ·ä¾†é‚„è¡Œ
  * [https://aur.archlinux.org/packages/coturn-git/](https://aur.archlinux.org/packages/coturn-git/)
  * [https://github.com/coturn/coturn](https://github.com/coturn/coturn)
  * [https://aur.archlinux.org/packages/stund](https://aur.archlinux.org/packages/stund)
* åˆ†æ•£å¼ï¼Œä¸¦ä¸”åŒæ™‚å¯ä»¥é¿å…å­¤å³¶ç”¢ç”Ÿçš„æ©Ÿåˆ¶
  * æ„Ÿè¦ºä¸Š [Distributed hash table](https://zh.wikipedia.org/wiki/%E5%88%86%E6%95%A3%E5%BC%8F%E9%9B%9C%E6%B9%8A%E8%A1%A8) å¯èƒ½æ˜¯è§£æ³•ä¹‹ä¸€
* å°æƒ¡æ„æˆ–æ˜¯ä¸æ­£å¸¸ç¯€é»çš„è™•ç†æ–¹æ³•
* é‡‹å‡ºç‚ºä¸€å€‹é€£ç·šæ¡†æ¶ä»¥åŠä¸€ä»½çœ‹å¾—æ‡‚çš„æ–‡ä»¶

å€‹äººæ˜¯æœŸæœ›é€™å€‹ network å¯ä»¥åšåˆ°é€™äº›äº‹æƒ…ï¼š

* ç€è¦½å™¨ä¸éœ€å®‰è£ä»»ä½• plugins / add-ons å°±å¯ä»¥ä½¿ç”¨åˆ†æ•£å¼æ‡‰ç”¨ç¨‹å¼
* é™ä½æ¶è¨­ wss çš„æŠ€è¡“é–€æª»ï¼Œäººäººéƒ½å¯ä»¥æˆç‚ºç¶²è·¯é€²å…¥é»
* è®“ä¸åŒæ‡‰ç”¨ç¨‹å¼å¯ä»¥å…±ç”¨é€™å€‹ network ä¾†å»ºæ§‹å¤šäººéŠæˆ²ã€å…±ç­†ç³»çµ±ç­‰

å¦‚æœçœ‹å®Œæœ‰èˆˆè¶£æ­¡è¿ä¾†æŒ‰å€‹æ˜Ÿæ˜Ÿè®“æˆ‘çŸ¥é“é€™å€‹æ±è¥¿å¯ä»¥ç¹¼çºŒåšï¼Œæˆ–æ˜¯é€éæˆ‘çš„å€‹äººç¶²ç«™ [https://pastleo.me/](https://pastleo.me/) ä¸Šçš„è¯çµ¡æ–¹å¼æ‰¾åˆ°æˆ‘ï¼Œæ„Ÿè¬å„ä½çš„é–±è®€ï¼